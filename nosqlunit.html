<html><head>
      <meta http-equiv="Content-Type" content="text/html; charset=ISO-8859-1">
   <title>NoSQLUnit</title><link rel="stylesheet" type="text/css" href="stylesheet.css"><meta name="generator" content="DocBook XSL-NS Stylesheets V1.76.1"></head><body bgcolor="white" text="black" link="#0000FF" vlink="#840084" alink="#0000FF"><div class="article" title="NoSQLUnit"><div class="titlepage"><div><div><h1 class="title"><a name="d0e1"></a>
			NoSQLUnit
		</h1></div><div><h3 class="subtitle"><i>Version 0.3.0</i></h3></div><div><div class="author"><h3 class="author"><span class="firstname">Alex</span> <span class="surname">Soto</span></h3><div class="affiliation"><span class="orgname">www.lordofthejars.com<br></span></div></div></div><div><p class="copyright">Copyright &copy; 2012 Alex Soto Bueno. Licensed under the Apache License, Version 2.0 (the "License");</p></div><div><p class="pubdate">2012</p></div></div><hr></div><div class="toc"><p><b>Table of Contents</b></p><dl><dt><span class="section"><a href="#d0e26">Overview</a></span></dt><dt><span class="section"><a href="#d0e102">Requirements</a></span></dt><dt><span class="section"><a href="#d0e127">NoSQLUnit</a></span></dt><dd><dl><dt><span class="section"><a href="#d0e186">Seeding Database</a></span></dt><dt><span class="section"><a href="#d0e271">Verifying Database</a></span></dt></dl></dd><dt><span class="section"><a href="#d0e311">MongoDb</a></span></dt><dd><dl><dt><span class="section"><a href="#d0e378">Maven Setup</a></span></dt><dt><span class="section"><a href="#d0e450">Dataset Format</a></span></dt><dt><span class="section"><a href="#d0e473">Getting Started</a></span></dt></dl></dd><dt><span class="section"><a href="#d0e838">Future releases</a></span></dt><dt><span class="section"><a href="#d0e859">Stay in Touch</a></span></dt></dl></div><div class="section" title="Overview"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="d0e26"></a>Overview</h2></div></div></div><span class="inlinemediaobject"><img src="fig/nosqlunitlogo.png"></span><p>
			Unit testing is a method by which the smallest testable part of an
			application is validated. Unit tests must follow the
			<acronym class="acronym">FIRST</acronym>
			Rules; these are Fast, Isolated, Repeatable,
			Self-Validated and Timely.
		</p><p>
			It is strange to think about a
			<acronym class="acronym">JEE</acronym>
			application
			without persistence layer (typical Relational databases or new
			<span class="emphasis"><em>NoSQL</em></span>
			databases) so should be interesting to write
			unit tests of persistence layer too. When we are writing unit tests of
			persistence layer we should focus on to not break two main concepts
			of
			<acronym class="acronym">FIRST</acronym>
			rules, the fast and the isolated ones.
		</p><p>
			Our tests will be
			<span class="emphasis"><em>fast</em></span>
			if they don't access
			network nor filesystem, and in case of persistence systems network and
			filesystem are the most used resources. In case of
			<acronym class="acronym">RDBMS</acronym>
			(
			<span class="emphasis"><em>SQL</em></span>
			), many Java in-memory
			databases exist like
			<span class="application">Apache Derby</span>
			,
			<span class="application">H2</span>
			or
			<span class="application">HSQLDB</span>
			. These
			databases, as their name suggests are embedded into your program and data
			are stored in memory, so your tests are still fast. The problem is with
			<span class="emphasis"><em>NoSQL</em></span>
			systems, because of their heterogeneity. Some
			systems work using Document approach (like
			<span class="application">MongoDb</span>
			), other ones Column (like
			<span class="application">Hbase</span>
			), or Graph (like
			<span class="application">Neo4J</span>
			). For this reason the in-memory mode
			should be provided by the vendor, there is no a generic solution.
		</p><p>
			Our tests must be isolated from themselves. It is not acceptable
			that one test method modifies the result of another test method. In case
			of persistence tests this scenario occurs when previous test method
			insert
			an entry to database and next test method execution finds the change.
			So
			before execution of each test, database should be found in a known state.
			Note that if your test found database in a known state, test will be
			repeatable, if test assertion depends on previous test execution, each
			execution will be unique. For homogeneous systems like
			<acronym class="acronym">RDBMS</acronym>
			,
			<span class="emphasis"><em>DBUnit</em></span>
			exists to maintain
			database in a known state before each execution. But there is no like
			<span class="emphasis"><em>DBUnit</em></span>
			framework for heterogeneous
			<span class="emphasis"><em>NoSQL</em></span>
			systems.
		</p><p>
			<span class="bold"><strong>NoSQLUnit</strong></span>
			resolves this problem by
			providing a
			<span class="emphasis"><em>JUnit</em></span>
			extension which helps us to manage
			lifecycle of NoSQL systems and also take care of maintaining databases
			into known state.
		</p></div><div class="section" title="Requirements"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="d0e102"></a>Requirements</h2></div></div></div><p>
			To run
			<span class="bold"><strong>NoSQLUnit</strong></span>
			,
			<span class="emphasis"><em>JUnit
				4.10
			</em></span>
			or later must be provided. This is because of
			<span class="bold"><strong>NoSQLUnit</strong></span>
			is using
			<span class="emphasis"><em>Rules</em></span>
			, and
			they have changed from previous versions to 4.10.
		</p><p>
			Although it should work with
			<acronym class="acronym">JDK 5</acronym>
			, jars are
			compiled using
			<acronym class="acronym">JDK 6</acronym>
			.
		</p></div><div class="section" title="NoSQLUnit"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="d0e127"></a>NoSQLUnit</h2></div></div></div><p>
			<span class="bold"><strong>NoSQLUnit</strong></span>
			is a
			<span class="emphasis"><em>JUnit</em></span>
			extension to make writing unit and integration
			tests of systems that use NoSQL backend easier and is composed by two sets
			of
			<span class="emphasis"><em>Rules</em></span>
			and a group of annotations.
		</p><p>
			First set of
			<span class="emphasis"><em>Rules</em></span>
			are those responsible of
			managing database lifecycle; there are two for each supported
			backend.
		</p><div class="itemizedlist"><ul class="itemizedlist" type="disc"><li class="listitem"><p>
					The first one (in case it is possible) it is the
					<span class="bold"><strong>in-memory</strong></span>
					mode. This mode takes care of
					starting and stopping database system in
					"
					<span class="emphasis"><em>in-memory</em></span>
					" mode. This mode will be typically
					used during unit testing execution.
				</p></li><li class="listitem"><p>
					The second one is the
					<span class="bold"><strong>managed</strong></span>
					mode. This mode is in charge of starting
					<span class="emphasis"><em>NoSQL</em></span>
					server but as remote process (in local machine) and stopping it.
					This
					will typically used during integration testing execution.
				</p></li></ul></div><p>
			Second set of
			<span class="emphasis"><em>Rules</em></span>
			are those responsible of
			maintaining database into known state. Each supported backend will have
			its own, and can be understood as a connection to defined database which
			will be used to execute the required operations for maintaining the
			stability of the system.
		</p><p>
			Note that because
			<span class="emphasis"><em>NoSQL</em></span>
			databases are
			heterogeneous, each system will require its own implementation.
		</p><p>
			And finally two annotations are provided,
			<a class="link" href="#seeding_database">@UsingDataSet</a>
			and
			<a class="link" href="#verifying_database">@ShouldMatchDataSet</a>
			, (thank you so
			much
			<span class="emphasis"><em>Arquillian</em></span>
			people for the name).
		</p><div class="section" title="Seeding Database"><div class="titlepage"><div><div><h3 class="title"><a name="d0e186"></a>Seeding Database</h3></div></div></div><p>
				@UsingDataSet is used to seed database with defined data set. In
				brief data sets are files that contain all data to be inserted to
				configured database. In order to seed your database, use
				<span class="emphasis"><em>@UsingDataSet</em></span>
				annotation, you can define it either
				on the test itself or on the class level. If there is definition on
				both, test level annotation takes precedence. This annotation has
				two
				attributes
				<code class="methodname">locations</code>
				and
				<code class="methodname">loadStrategy</code>
				.
			</p><p>
				With
				<code class="methodname">locations</code>
				attribute you can specify
				<span class="bold"><strong>classpath</strong></span>
				datasets location. Locations
				are relative to test class location. Note that more than one dataset
				can
				be specified. If files are not specified explicitly, next strategy is
				applied:
			</p><div class="itemizedlist"><ul class="itemizedlist" type="disc"><li class="listitem"><p>
						First searches for a file on classpath in same package of test
						class with next file name,
						<code class="filename">[test class name]#[test method
							name].[format]
						</code>
						(only if annotation is present at test
						method).
					</p></li><li class="listitem"><p>
						If first rule is not met or annotation is defined at class
						scope, next file is searched on classpath in same package of test
						class,
						<code class="filename">[test class name].[default format]</code>
						.
					</p></li></ul></div><div class="warning" title="Warning" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title">Warning</h3><p>
					datasets must reside into
					<span class="emphasis"><em>classpath</em></span>
					and
					format depends on
					<span class="emphasis"><em>NoSQL</em></span>
					vendor.
				</p></div><p>Second attribute provides strategies for inserting data.
				Implemented strategies are:
			</p><table border="1" id="d0e232"><caption>Table&nbsp;1.&nbsp;Load Strategies</caption><tr>
					<td>INSERT</td>

					<td>Insert defined datasets before executing any test method.</td>
				</tr><tr>
					<td>DELETE_ALL</td>

					<td>Deletes all elements of database before executing any test
						method.
					</td>
				</tr><tr>
					<td>CLEAN_INSERT</td>

					<td>This is the most used strategy. It deletes all elements of
						database and then insert defined datasets before executing any
						test
						method.
					</td>
				</tr><tr>
					<td>REFRESH</td>

					<td>Insert all data defined in datasets that are not present on
						database.
					</td>
				</tr></table><p>An example of usage:</p><pre class="programlisting">@UsingDataSet(locations=<strong class="hl-string"><em style="color:red">"my_data_set.json"</em></strong>, loadStrategy=LoadStrategyEnum.REFRESH)</pre></div><div class="section" title="Verifying Database"><div class="titlepage"><div><div><h3 class="title"><a name="d0e271"></a>Verifying Database</h3></div></div></div><p>
				Sometimes it might imply a huge amount of work asserting database
				state directly from testing code. By using
				<span class="emphasis"><em>@ShouldMatchDataSet</em></span>
				on test method,
				<span class="bold"><strong>NoSQLUnit</strong></span>
				will check if database contains
				expected entries after test execution. As with
				<span class="emphasis"><em>@ShouldMatchDataSet</em></span>
				annotation you can define
				classpath file location, or if it is not supplied next convention is
				used:
			</p><div class="itemizedlist"><ul class="itemizedlist" type="disc"><li class="listitem"><p>
						First searches for a file on classpath in same package of test
						class with next file name,
						<code class="filename">[test class name]#[test method
							name]-expected.[format]
						</code>
						(only if annotation is present at
						test method).
					</p></li><li class="listitem"><p>
						If first rule is not met or annotation is defined at class
						scope, file is searched on classpath in same package of test class,
						<code class="filename">[test class name]-expected.[default format]</code>
						.
					</p></li></ul></div><div class="warning" title="Warning" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title">Warning</h3><p>
					datasets must reside into
					<span class="emphasis"><em>classpath</em></span>
					and
					format depends on
					<span class="emphasis"><em>NoSQL</em></span>
					vendor.
				</p></div><p>An example of usage:</p><pre class="programlisting">@ShouldMatchDataSet(location=<strong class="hl-string"><em style="color:red">"my_expected_data_set.json"</em></strong>)</pre></div></div><div class="section" title="MongoDb"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="d0e311"></a>MongoDb</h2></div></div></div><p>
			<span class="application">MongoDb</span>
			is a
			<span class="emphasis"><em>NoSQL</em></span>
			database that stores structured data as
			<span class="emphasis"><em>JSON-like</em></span>
			documents with dynamic schemas.
		</p><p>
			<span class="bold"><strong>NoSQLUnit</strong></span>
			supports
			<span class="emphasis"><em>MongoDb</em></span>
			by using next classes:
		</p><p>
		</p><table border="1" id="d0e335"><caption>Table&nbsp;2.&nbsp;Lifecycle Management Rules</caption><tr>
				<td>In Memory</td>

				<td>
					<code class="classname">com.lordofthejars.nosqlunit.mongodb.InMemoryMongoDb
					</code>
				</td>
			</tr><tr>
				<td>Managed</td>

				<td>
					<code class="classname">com.lordofthejars.nosqlunit.mongodb.ManagedMongoDb
					</code>
				</td>
			</tr></table><p>
		</p><p>
		</p><table border="1" id="d0e363"><caption>Table&nbsp;3.&nbsp;Manager Rule</caption><tr>
				<td>NoSQLUnit Management</td>

				<td>
					<code class="classname">com.lordofthejars.nosqlunit.mongodb.MongoDbRule
					</code>
				</td>
			</tr></table><p>
		</p><div class="section" title="Maven Setup"><div class="titlepage"><div><div><h3 class="title"><a name="d0e378"></a>Maven Setup</h3></div></div></div><p>
				To use
				<span class="bold"><strong>NoSQLUnit</strong></span>
				with
				<span class="application">MongoDb</span>
				you only need to add next
				dependency:
			</p><div class="example"><a name="conf.nosqlunit_dep"></a><p class="title"><b>Example&nbsp;1.&nbsp;NoSqlUnit Maven Repository</b></p><div class="example-contents"><pre class="programlisting"><strong class="hl-tag" style="color: #000096">&lt;dependency&gt;</strong>
	<strong class="hl-tag" style="color: #000096">&lt;groupId&gt;</strong>com.lordofthejars<strong class="hl-tag" style="color: #000096">&lt;/groupId&gt;</strong>
	<strong class="hl-tag" style="color: #000096">&lt;artifactId&gt;</strong>nosqlunit-mongodb<strong class="hl-tag" style="color: #000096">&lt;/artifactId&gt;</strong>
	<strong class="hl-tag" style="color: #000096">&lt;version&gt;</strong>${version.nosqlunit}<strong class="hl-tag" style="color: #000096">&lt;/version&gt;</strong>
<strong class="hl-tag" style="color: #000096">&lt;/dependency&gt;</strong></pre></div></div><br class="example-break"><p>
				Note that if you are plannig to use
				<span class="bold"><strong>in-memory</strong></span>
				approach an extra dependency is
				required.
				<span class="bold"><strong>In-memory</strong></span>
				mode is implemented
				using
				<span class="emphasis"><em>jmockmongo</em></span>
				.
				<span class="emphasis"><em>JMockmongo</em></span>
				is a new project that help with unit testing Java-based
				<span class="application">MongoDb</span>
				Applications by starting an
				in-process
				<span class="emphasis"><em>Netty</em></span>
				server that speaks the
				<span class="emphasis"><em>MongoDb</em></span>
				protocol and maintains databases and
				collections in
				<acronym class="acronym">JVM</acronym>
				memory. It is not a true embedded
				mode becuase it will starts a server, but in fact for now it is the best
				way to write
				<span class="application">MongoDb</span>
				unit tests. As his
				author says it is an incomplete tool and will be improved every time a
				new feature is required.
			</p><div class="warning" title="Warning" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title">Warning</h3><p>
					During development of this documentation, current
					<span class="emphasis"><em>jmockmongo</em></span>
					version was 0.0.2-SNAPSHOT. Author is
					imporoving version often so before using one specific version, take a
					look at its
					<a class="link" href="https://github.com/thiloplanz/jmockmongo" target="_top">website</a>
					.
				</p></div><p>
				To install add next
				<a class="link" href="#conf.jmockmongo_repo" title="Example&nbsp;2.&nbsp;jmockmongo Maven Repository">
					repository
				</a>
				and
				<a class="link" href="#conf.jmockmongo_dep" title="Example&nbsp;3.&nbsp;jmockmongo Maven Dependency">
					dependency
				</a>
				:
			</p><div class="example"><a name="conf.jmockmongo_repo"></a><p class="title"><b>Example&nbsp;2.&nbsp;jmockmongo Maven Repository</b></p><div class="example-contents"><pre class="programlisting"><strong class="hl-tag" style="color: #000096">&lt;repositories&gt;</strong>
	<strong class="hl-tag" style="color: #000096">&lt;repository&gt;</strong>
		<strong class="hl-tag" style="color: #000096">&lt;id&gt;</strong>thiloplanz-snapshot<strong class="hl-tag" style="color: #000096">&lt;/id&gt;</strong>
		<strong class="hl-tag" style="color: #000096">&lt;url&gt;</strong>http://repository-thiloplanz.forge.cloudbees.com/snapshot/<strong class="hl-tag" style="color: #000096">&lt;/url&gt;</strong>
	<strong class="hl-tag" style="color: #000096">&lt;/repository&gt;</strong>
<strong class="hl-tag" style="color: #000096">&lt;/repositories&gt;</strong></pre></div></div><br class="example-break"><div class="example"><a name="conf.jmockmongo_dep"></a><p class="title"><b>Example&nbsp;3.&nbsp;jmockmongo Maven Dependency</b></p><div class="example-contents"><pre class="programlisting"><strong class="hl-tag" style="color: #000096">&lt;dependency&gt;</strong>
	<strong class="hl-tag" style="color: #000096">&lt;groupId&gt;</strong>jmockmongo<strong class="hl-tag" style="color: #000096">&lt;/groupId&gt;</strong>
	<strong class="hl-tag" style="color: #000096">&lt;artifactId&gt;</strong>jmockmongo<strong class="hl-tag" style="color: #000096">&lt;/artifactId&gt;</strong>
	<strong class="hl-tag" style="color: #000096">&lt;version&gt;</strong>${mongomock.version}<strong class="hl-tag" style="color: #000096">&lt;/version&gt;</strong>
<strong class="hl-tag" style="color: #000096">&lt;/dependency&gt;</strong></pre></div></div><br class="example-break"></div><div class="section" title="Dataset Format"><div class="titlepage"><div><div><h3 class="title"><a name="d0e450"></a>Dataset Format</h3></div></div></div><p>
				Default dataset file format in
				<span class="emphasis"><em>MongoDb</em></span>
				module
				is
				<span class="emphasis"><em>json</em></span>
				.
			</p><p>
				Datasets must have next
				<a class="link" href="#ex.mongodb_dataset" title="Example&nbsp;4.&nbsp;Example of MongoDb Dataset">
					format
				</a>
				:
			</p><div class="example"><a name="ex.mongodb_dataset"></a><p class="title"><b>Example&nbsp;4.&nbsp;Example of MongoDb Dataset</b></p><div class="example-contents"><pre class="programlisting">{
	"name_collection1": [
	{
		"attribute_1":"value1",
		"attribute_2":"value2"
	},
	{
		"attribute_3":2,
		"attribute_4":"value4"
	}
	],
	"name_collection2": [
		...
	],
	....
}</pre></div></div><br class="example-break"><p>Notice that if attributes value are integers, double quotes are
				not required.
			</p></div><div class="section" title="Getting Started"><div class="titlepage"><div><div><h3 class="title"><a name="d0e473"></a>Getting Started</h3></div></div></div><div class="section" title="Lifecycle Management Strategy"><div class="titlepage"><div><div><h4 class="title"><a name="d0e476"></a>Lifecycle Management Strategy</h4></div></div></div><p>
					First step is defining which lifecycle management strategy is
					required for your tests. Depending on kind of test you are
					implementing (unit test, integration test, deployment test, ...)
					you
					will require an
					<span class="bold"><strong>in-memory</strong></span>
					approach,
					<span class="bold"><strong>managed</strong></span>
					approach or
					<span class="bold"><strong>remote</strong></span>
					approach.
				</p><p>
					To configure
					<span class="bold"><strong>in-memory</strong></span>
					approach
					you should only instantiate next
					<a class="link" href="#program.inmemory_conf" title="Example&nbsp;5.&nbsp;In-memory MongoDb">rule</a>
					:
				</p><div class="example"><a name="program.inmemory_conf"></a><p class="title"><b>Example&nbsp;5.&nbsp;In-memory MongoDb</b></p><div class="example-contents"><pre class="programlisting"><em><span class="hl-annotation" style="color: gray">@ClassRule</span></em>
InMemoryMongoDb inMemoryMongoDb = <strong class="hl-keyword">new</strong> InMemoryMongoDb();</pre></div></div><br class="example-break"><p>
					To configure the
					<span class="bold"><strong>managed</strong></span>
					way,
					you should use
					<code class="classname">ManagedMongoDb</code>
					rule and may
					require some <a class="link" href="#program.managed_conf" title="Example&nbsp;6.&nbsp;Managed MongoDb">configuration</a> parameters.
				</p><div class="example"><a name="program.managed_conf"></a><p class="title"><b>Example&nbsp;6.&nbsp;Managed MongoDb</b></p><div class="example-contents"><pre class="programlisting"><strong class="hl-keyword">import</strong> <strong class="hl-keyword">static</strong> com.lordofthejars.nosqlunit.mongodb.ManagedMongoDb.MongoServerRuleBuilder.newManagedMongoDbRule;

<em><span class="hl-annotation" style="color: gray">@ClassRule</span></em>
<strong class="hl-keyword">public</strong> <strong class="hl-keyword">static</strong> ManagedMongoDb managedMongoDb = newManagedMongoDbRule().build();</pre></div></div><br class="example-break"><p>
					By default managed
					<span class="emphasis"><em>MongoDb</em></span>
					rule uses next
					default values:
				</p><div class="itemizedlist"><ul class="itemizedlist" type="disc"><li class="listitem"><p>
							<span class="emphasis"><em>MongoDb</em></span>
							installation directory is
							retrieved from
							<code class="varname">MONGO_HOME</code>
							system environment
							variable.
						</p></li><li class="listitem"><p>
							Target path, that is the directory where
							<span class="emphasis"><em>MongoDb</em></span>
							server is started, is
							<code class="constant">target/mongo-temp</code>
							.
						</p></li><li class="listitem"><p>
							Database path is at
							<em class="parameter"><code>{target
								path}
							</code></em>
							<code class="constant">/mongo-dbpath</code>
							.
						</p></li><li class="listitem"><p>
							<span class="emphasis"><em>Mongodb</em></span>
							is started with
							<span class="emphasis"><em>fork</em></span>
							option.
						</p></li><li class="listitem"><p>
							Because after execution of tests all generated data is
							removed, in
							<em class="parameter"><code>{target
								path}
							</code></em>
							<code class="constant">/logpath</code>
							will remain log
							file generated by the server.
						</p></li><li class="listitem"><p>
							In
							<span class="emphasis"><em>Windows</em></span> systems
							executable should be found as
							<code class="filename">bin/mongod.exe</code>
							meanwhile in
							<span class="emphasis"><em>MAC
								OS
							</em></span>
							and
							<span class="emphasis"><em>*nix</em></span>
							should be found as
							<code class="filename">bin/mongod</code>
							.
						</p></li></ul></div><p>
					<code class="classname">ManagedMongoDb</code>
					can be created from
					scratch, but for making life easier, a
					<span class="emphasis"><em>DSL</em></span>
					is
					provided using
					<code class="classname">MongoServerRuleBuilder</code>
					class.
					For
					<a class="link" href="#program.managed_specific_conf" title="Example&nbsp;7.&nbsp;Specific Managed MongoDb Configuration">example</a>
					:
				</p><div class="example"><a name="program.managed_specific_conf"></a><p class="title"><b>Example&nbsp;7.&nbsp;Specific Managed MongoDb Configuration</b></p><div class="example-contents"><pre class="programlisting"><strong class="hl-keyword">import</strong> <strong class="hl-keyword">static</strong> com.lordofthejars.nosqlunit.mongodb.ManagedMongoDb.MongoServerRuleBuilder.newManagedMongoDbRule;

<em><span class="hl-annotation" style="color: gray">@ClassRule</span></em>
<strong class="hl-keyword">public</strong> <strong class="hl-keyword">static</strong> ManagedMongoDb managedMongoDb =
newManagedMongoDbRule().mongodPath(<strong class="hl-string"><em style="color:red">"/opt/mongo"</em></strong>).appendSingleCommandLineArguments(<strong class="hl-string"><em style="color:red">"-vvv"</em></strong>).build();</pre></div></div><br class="example-break"><p>
					In
					<a class="link" href="#program.managed_specific_conf" title="Example&nbsp;7.&nbsp;Specific Managed MongoDb Configuration">example</a>
					we are overriding
					<code class="varname">MONGO_HOME</code>
					variable (in case has
					been set) and set mongo home at
					<code class="filename">/opt/mongo</code>
					.
					Moreover we are appending a single argument to
					<span class="emphasis"><em>MongoDb</em></span>
					executable, in this case setting log
					level to number 3 (-vvv). Also you can append
					<span class="emphasis"><em>property=value</em></span>
					arguments using
					<code class="function">appendCommandLineArguments(String argumentName, String
						argumentValue)
					</code>
					method.
				</p><div class="warning" title="Warning" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title">Warning</h3><p>when you are specifying command line arguments, remember to
						add slash (-) and double slash (--) where is necessary.
					</p></div><p>
					To stop
					<span class="emphasis"><em>MongoDb</em></span>
					instance,
					<span class="bold"><strong>NoSQLUnit</strong></span>
					sends a
					<code class="function">shutdown</code>
					command to server using
					<span class="emphasis"><em>Java Mongo AP</em></span>
					I. When this
					command is sent, the server is stopped and because connection is lost,
					<span class="emphasis"><em>Java Mongo API</em></span>
					logs automatically an exception
					(read
					<a class="link" href="https://groups.google.com/group/mongodb-user/browse_thread/thread/ac9a4c9ea13f3e81" target="_top">here</a>
					information about the problem and how to "resolve" it). Do not
					confuse
					with a testing failure. You will see something like:
				</p><pre class="screen">java.io.EOFException
	at org.bson.io.Bits.readFully(Bits.java:37)
	at org.bson.io.Bits.readFully(Bits.java:28)
	at com.mongodb.Response.&lt;init&gt;;(Response.java:39)
	at com.mongodb.DBPort.go(DBPort.java:128)
	at com.mongodb.DBPort.call(DBPort.java:79)
	at com.mongodb.DBTCPConnector.call(DBTCPConnector.java:218)
	at com.mongodb.DBApiLayer$MyCollection.__find(DBApiLayer.java:305)
	at com.mongodb.DB.command(DB.java:160)
	at com.mongodb.DB.command(DB.java:183)
	at com.mongodb.DB.command(DB.java:144)
	at
	com.lordofthejars.nosqlunit.mongodb.MongoDbLowLevelOps.shutdown(MongoDbLowLevelOps.java:44)
	at
	com.lordofthejars.nosqlunit.mongodb.ManagedMongoDb.after(ManagedMongoDb.java:157)
	at
	org.junit.rules.ExternalResource$1.evaluate(ExternalResource.java:48)
	at org.junit.rules.RunRules.evaluate(RunRules.java:18)
	at org.junit.runners.ParentRunner.run(ParentRunner.java:300)
	at
	org.apache.maven.surefire.junit4.JUnit4Provider.execute(JUnit4Provider.java:236)
	at
	org.apache.maven.surefire.junit4.JUnit4Provider.executeTestSet(JUnit4Provider.java:134)
	at
	org.apache.maven.surefire.junit4.JUnit4Provider.invoke(JUnit4Provider.java:113)
	at sun.reflect.NativeMethodAccessorImpl.invoke0(Native Method)
	at
	sun.reflect.NativeMethodAccessorImpl.invoke(NativeMethodAccessorImpl.java:57)
	at
	sun.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:43)
	at java.lang.reflect.Method.invoke(Method.java:616)
	at
	org.apache.maven.surefire.util.ReflectionUtils.invokeMethodWithArray(ReflectionUtils.java:189)
	at
	org.apache.maven.surefire.booter.ProviderFactory$ProviderProxy.invoke(ProviderFactory.java:165)
	at
	org.apache.maven.surefire.booter.ProviderFactory.invokeProvider(ProviderFactory.java:85)
	at
	org.apache.maven.surefire.booter.ForkedBooter.runSuitesInProcess(ForkedBooter.java:103)
	at
	org.apache.maven.surefire.booter.ForkedBooter.main(ForkedBooter.java:74)</pre><p>
					Configuring
					<span class="bold"><strong>remote</strong></span>
					approach
					does not require any special rule because you (or System like
					<span class="application">Maven</span>
					) is the responsible of starting and
					stopping the server. This mode is used in deployment tests where you
					are testing your application on real environment.
				</p></div><div class="section" title="Configuring MongoDb Connection"><div class="titlepage"><div><div><h4 class="title"><a name="d0e660"></a>Configuring MongoDb Connection</h4></div></div></div><p>
					Next step is configuring
					<span class="emphasis"><em>
						<span class="bold"><strong>Mongodb</strong></span>
					</em></span>
					rule in charge of
					maintaining
					<span class="emphasis"><em>MongoDb</em></span>
					database into known state by
					inserting and deleting defined datasets. You must register
					<code class="classname">MongoDbRule</code>
					<span class="emphasis"><em>JUnit</em></span>
					rule
					class, which requires a configuration parameter with information like
					host, port or database name.
				</p><p>To make developer's life easier and code more readable, a
					fluent
					interface can be used to create these configuration objects. Two
					different kind of configuration builders exist.
				</p><p>
					The first one is for configuring a connection to in-memory
					<span class="emphasis"><em>jmockmongo</em></span>
					server. Default connection values
					are:
				</p><table border="1" id="d0e687"><caption>Table&nbsp;4.&nbsp;Default In-Memory Configuration Values</caption><tr>
						<td>Host</td>

						<td>0.0.0.0</td>
					</tr><tr>
						<td>Port</td>

						<td>2307</td>
					</tr></table><p>
					Notice that these values are the default ones of
					<span class="emphasis"><em>jmockmongo</em></span>
					project, so if you are thinking to use
					<span class="emphasis"><em>jmockmongo</em></span>
					, no modifications are required.
				</p><div class="example"><a name="program.in_memory_connection_parameters"></a><p class="title"><b>Example&nbsp;8.&nbsp;MongoDbRule with in-memory configuration</b></p><div class="example-contents"><pre class="programlisting"><strong class="hl-keyword">import</strong> <strong class="hl-keyword">static</strong> com.lordofthejars.nosqlunit.mongodb.InMemoryMongoDbConfigurationBuilder.inMemoryMongoDb;

<em><span class="hl-annotation" style="color: gray">@Rule</span></em>
<strong class="hl-keyword">public</strong> MongoDbRule remoteMongoDbRule = <strong class="hl-keyword">new</strong> MongoDbRule(inMemoryMongoDb().databaseName(<strong class="hl-string"><em style="color:red">"test"</em></strong>).build());</pre></div></div><br class="example-break"><p>
					The second one is for configuring a connection to remote
					<span class="emphasis"><em>MongoDb</em></span>
					server. Default values are:
				</p><table border="1" id="d0e724"><caption>Table&nbsp;5.&nbsp;Default Managed Configuration Values</caption><tr>
						<td>Host</td>

						<td>localhost</td>
					</tr><tr>
						<td>Port</td>

						<td>27017</td>
					</tr><tr>
						<td>Authentication</td>

						<td>No authentication parameters.</td>
					</tr></table><div class="example"><a name="program.managed_connection_parameters"></a><p class="title"><b>Example&nbsp;9.&nbsp;MongoDbRule with managed configuration</b></p><div class="example-contents"><pre class="programlisting"><strong class="hl-keyword">import</strong> <strong class="hl-keyword">static</strong> com.lordofthejars.nosqlunit.mongodb.MongoDbConfigurationBuilder.mongoDb;

<em><span class="hl-annotation" style="color: gray">@Rule</span></em>
<strong class="hl-keyword">public</strong> MongoDbRule remoteMongoDbRule = <strong class="hl-keyword">new</strong> MongoDbRule(mongoDb().databaseName(<strong class="hl-string"><em style="color:red">"test"</em></strong>).build());</pre></div></div><br class="example-break"><div class="example"><a name="program.remote_connection_parameters"></a><p class="title"><b>Example&nbsp;10.&nbsp;MongoDbRule with remote configuration</b></p><div class="example-contents"><pre class="programlisting"><strong class="hl-keyword">import</strong> <strong class="hl-keyword">static</strong> com.lordofthejars.nosqlunit.mongodb.MongoDbConfigurationBuilder.mongoDb;

<em><span class="hl-annotation" style="color: gray">@Rule</span></em>
<strong class="hl-keyword">public</strong> MongoDbRule remoteMongoDbRule = <strong class="hl-keyword">new</strong> MongoDbRule(mongoDb().databaseName(<strong class="hl-string"><em style="color:red">"test"</em></strong>).host(<strong class="hl-string"><em style="color:red">"my_remote_host"</em></strong>).build());</pre></div></div><br class="example-break"></div><div class="section" title="Complete Example"><div class="titlepage"><div><div><h4 class="title"><a name="d0e761"></a>Complete Example</h4></div></div></div><p>
					Consider a library application, which apart from multiple
					operations, it allow us to add new books to system. Our
					<a class="link" href="#example.book_model" title="Example&nbsp;11.&nbsp;Book POJO">model</a>
					is as simple as:
				</p><div class="example"><a name="example.book_model"></a><p class="title"><b>Example&nbsp;11.&nbsp;Book POJO</b></p><div class="example-contents"><pre class="programlisting"><strong class="hl-keyword">public</strong> <strong class="hl-keyword">class</strong> Book {

	<strong class="hl-keyword">private</strong> String title;

	<strong class="hl-keyword">private</strong> <strong class="hl-keyword">int</strong> numberOfPages;

	<strong class="hl-keyword">public</strong> Book(String title, <strong class="hl-keyword">int</strong> numberOfPages) {
		<strong class="hl-keyword">super</strong>();
		<strong class="hl-keyword">this</strong>.title = title;
		<strong class="hl-keyword">this</strong>.numberOfPages = numberOfPages;
	}

	<strong class="hl-keyword">public</strong> <strong class="hl-keyword">void</strong> setTitle(String title) {
		<strong class="hl-keyword">this</strong>.title = title;
	}

	<strong class="hl-keyword">public</strong> <strong class="hl-keyword">void</strong> setNumberOfPages(<strong class="hl-keyword">int</strong> numberOfPages) {
		<strong class="hl-keyword">this</strong>.numberOfPages = numberOfPages;
	}


	<strong class="hl-keyword">public</strong> String getTitle() {
		<strong class="hl-keyword">return</strong> title;
	}

	<strong class="hl-keyword">public</strong> <strong class="hl-keyword">int</strong> getNumberOfPages() {
		<strong class="hl-keyword">return</strong> numberOfPages;
	}
}</pre></div></div><br class="example-break"><p>
					Next business
					<a class="link" href="#example.book_manager" title="Example&nbsp;12.&nbsp;Book POJO">class</a>
					is the responsible of managing access to
					<span class="emphasis"><em>MongoDb</em></span>
					server:
				</p><div class="example"><a name="example.book_manager"></a><p class="title"><b>Example&nbsp;12.&nbsp;Book POJO</b></p><div class="example-contents"><pre class="programlisting"><strong class="hl-keyword">public</strong> <strong class="hl-keyword">class</strong> BookManager {

	<strong class="hl-keyword">private</strong> <strong class="hl-keyword">static</strong> <strong class="hl-keyword">final</strong> Logger LOGGER = LoggerFactory.getLogger(BookManager.<strong class="hl-keyword">class</strong>);

	<strong class="hl-keyword">private</strong> <strong class="hl-keyword">static</strong> <strong class="hl-keyword">final</strong> MongoDbBookConverter MONGO_DB_BOOK_CONVERTER = <strong class="hl-keyword">new</strong>	MongoDbBookConverter();
	<strong class="hl-keyword">private</strong> <strong class="hl-keyword">static</strong> <strong class="hl-keyword">final</strong> DbObjectBookConverter DB_OBJECT_BOOK_CONVERTER = <strong class="hl-keyword">new</strong> DbObjectBookConverter();

			
	<strong class="hl-keyword">private</strong> DBCollection booksCollection;

	<strong class="hl-keyword">public</strong> BookManager(DBCollection booksCollection) {
		<strong class="hl-keyword">this</strong>.booksCollection = booksCollection;
	}

	<strong class="hl-keyword">public</strong> <strong class="hl-keyword">void</strong> create(Book book) {
		DBObject dbObject = MONGO_DB_BOOK_CONVERTER.convert(book);
		booksCollection.insert(dbObject);
	}
}</pre></div></div><br class="example-break"><p>
					And now it is time for testing. In next
					<a class="link" href="#example.test_insert_book" title="Example&nbsp;13.&nbsp;Test with Managed Connection">test</a>
					we are going to
					validate that a book is inserted correctly into database.
				</p><div class="example"><a name="example.test_insert_book"></a><p class="title"><b>Example&nbsp;13.&nbsp;Test with Managed Connection</b></p><div class="example-contents"><pre class="programlisting"><strong class="hl-keyword">package</strong> com.lordofthejars.nosqlunit.demo.mongodb;

<strong class="hl-keyword">public</strong> <strong class="hl-keyword">class</strong> WhenANewBookIsCreated {

	<em><span class="hl-annotation" style="color: gray">@ClassRule</span></em>
	<strong class="hl-keyword">public</strong> <strong class="hl-keyword">static</strong> ManagedMongoDb managedMongoDb = newManagedMongoDbRule().mongodPath(<strong class="hl-string"><em style="color:red">"/opt/mongo"</em></strong>).build();

	<em><span class="hl-annotation" style="color: gray">@Rule</span></em>
	<strong class="hl-keyword">public</strong> MongoDbRule remoteMongoDbRule = <strong class="hl-keyword">new</strong> MongoDbRule(mongoDb().databaseName(<strong class="hl-string"><em style="color:red">"test"</em></strong>).build());

	<em><span class="hl-annotation" style="color: gray">@Test</span></em>
	<em><span class="hl-annotation" style="color: gray">@UsingDataSet(locations="initialData.json", loadStrategy=LoadStrategyEnum.CLEAN_INSERT)</span></em>
	<em><span class="hl-annotation" style="color: gray">@ShouldMatchDataSet(location="expectedData.json")</span></em>
	<strong class="hl-keyword">public</strong> <strong class="hl-keyword">void</strong> book_should_be_inserted_into_repository() {

		BookManager bookManager = <strong class="hl-keyword">new</strong> BookManager(MongoDbUtil.getCollection(Book.<strong class="hl-keyword">class</strong>.getSimpleName()));

		Book book = <strong class="hl-keyword">new</strong> Book(<strong class="hl-string"><em style="color:red">"The Lord Of The Rings"</em></strong>, <span class="hl-number">1299</span>);
		bookManager.create(book);
	}

}</pre></div></div><br class="example-break"><p>
					In
					<a class="link" href="#example.test_insert_book" title="Example&nbsp;13.&nbsp;Test with Managed Connection">previous</a>
					test
					we have defined that
					<span class="emphasis"><em>MongoDb</em></span>
					will be managed by
					test by starting an instance of server located at
					<code class="filename">/opt/mongo</code>
					. Moreover we are setting an
					<a class="link" href="#example.dataset_book" title="Example&nbsp;14.&nbsp;Initial Dataset">initial</a>
					dataset in file
					<code class="filename">initialData.json</code>
					located at classpath
					<code class="filename">com/lordofthejars/nosqlunit/demo/mongodb/initialData.json
					</code>
					and
					<a class="link" href="#example.expected_dataset_book" title="Example&nbsp;15.&nbsp;Expected Dataset">expected</a>
					dataset called
					<code class="filename">expectedData.json</code>
					.
				</p><div class="example"><a name="example.dataset_book"></a><p class="title"><b>Example&nbsp;14.&nbsp;Initial Dataset</b></p><div class="example-contents"><pre class="programlisting">{
	"Book":
	[
		{"title":"The Hobbit","numberOfPages":293}
	]
}</pre></div></div><br class="example-break"><div class="example"><a name="example.expected_dataset_book"></a><p class="title"><b>Example&nbsp;15.&nbsp;Expected Dataset</b></p><div class="example-contents"><pre class="programlisting">{
	"Book":
	[
		{"title":"The Hobbit","numberOfPages":293},
		{"title":"The Lord Of The Rings","numberOfPages":1299}
	]
}</pre></div></div><br class="example-break"><p>
					You can watch full example at
					<a class="link" href="https://github.com/lordofthejars/nosql-unit/tree/master/nosqlunit-demo" target="_top">github</a>
					.
				</p></div></div></div><div class="section" title="Future releases"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="d0e838"></a>Future releases</h2></div></div></div><p>
			In next project release 0.3.1, a new feature
			will be implemented. As features
			<span class="emphasis"><em> @Inject</em></span>
			will be able
			to be used to have access to underlying connection into tests.
		</p><p>
			Version 0.4.0 there will be support for
			<span class="emphasis"><em>Neo4J and
				Cassandra.
			</em></span>
		</p><p>
			Next versions will contain support for
			<span class="emphasis"><em>HBase</em></span>
			and
			<span class="emphasis"><em>CouchDb</em></span>
			.
		</p></div><div class="section" title="Stay in Touch"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="d0e859"></a>Stay in Touch</h2></div></div></div><table id="d0e862"><tr>
				<td>Email: </td>
				<td>asotobu at gmail.com</td>
			</tr><tr>
				<td>Blog: </td>
				<td><a class="link" href="www.lordofthejars.com" target="_top">Lord Of The Jars</a></td>
			</tr><tr>
				<td>Twitter: </td>
				<td>@alexsotob</td>
			</tr><tr>
				<td>Github: </td>
				<td><a class="link" href="https://github.com/lordofthejars/nosql-unit/" target="_top">NoSQLUnit Github</a></td>
			</tr></table></div></div></body></html>